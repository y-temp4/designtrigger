machine:
  timezone:
    Asia/Tokyo
  ruby:
    version: 2.4.2
  node:
    version: 6.11.1
  environment:
    RAILS_ENV: test
  post:
    - curl -o- -L https://yarnpkg.com/install.sh | bash

dependencies:
  override:
    - rm -rf vendor/bundle
    - bundle --without development production --path=vendor/bundle -j4:
        timeout: 180
    - yarn install
    - cd client && yarn run build:test
  cache_directories:
    - vendor/bundle
    - ~/.cache/yarn

database:
  pre:
    - mv config/database.yml.ci config/database.yml
  override:
    - bundle exec rake db:create db:schema:load
    - bundle exec rake db:migrate

test:
  override:
    - bin/rspec -r rspec_junit_formatter --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml
